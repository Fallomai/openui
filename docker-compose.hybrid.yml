version: '3.9'

# HYBRID MODE - OpenUI UI in container, AI agents on host
# NOTE: This is an advanced configuration that requires additional setup.
# The sessionManager.ts needs to be modified to spawn agents via SSH, Docker CLI, or IPC.
# See README for details on implementing hybrid mode agent spawning.

services:
  openui:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: openui-hybrid
    restart: unless-stopped

    # Port mappings
    ports:
      - "6968:6968"  # Backend + WebSocket

    # Volume mounts for hybrid mode
    volumes:
      # State persistence
      - openui-state:/root/.openui

      # Plugin directory (synced with host)
      - ${HOME}/.openui/claude-code-plugin:/root/.openui/claude-code-plugin

      # Project directories - MUST MATCH HOST PATHS
      # This allows agents to run on host but UI sees same files
      - ${PROJECT_DIR:-./projects}:${PROJECT_DIR:-/projects}

      # Docker socket for spawning agents on host (optional, for Docker CLI method)
      - /var/run/docker.sock:/var/run/docker.sock

      # Host binary access (if AI tools are installed in these locations)
      # Uncomment and adjust paths based on your host setup:
      # - /usr/local/bin/claude:/usr/local/bin/claude:ro
      # - /usr/local/bin/opencode:/usr/local/bin/opencode:ro

      # Git credentials
      - ${HOME}/.gitconfig:/root/.gitconfig:ro
      - ${HOME}/.ssh:/root/.ssh:ro

    # Environment variables
    environment:
      - NODE_ENV=production
      - PORT=6968
      - LAUNCH_CWD=${PROJECT_DIR:-/projects}
      - OPENUI_QUIET=1

      # Hybrid mode flag (for future use in sessionManager)
      - OPENUI_HYBRID_MODE=true

      # Path to host tools (accessed via mount) - adjust as needed
      # - CLAUDE_BIN_PATH=/usr/local/bin/claude
      # - OPENCODE_BIN_PATH=/usr/local/bin/opencode

    # Working directory
    working_dir: ${PROJECT_DIR:-/projects}

    # Network mode - use host to access host services
    # Alternatively, use 'bridge' and configure SSH to host
    network_mode: host

    # Extra capabilities for host process spawning (if needed)
    # Note: These may pose security risks - use with caution
    # cap_add:
    #   - SYS_PTRACE
    # security_opt:
    #   - apparmor:unconfined

    # Keep container running
    stdin_open: true
    tty: true

volumes:
  openui-state:
    driver: local
